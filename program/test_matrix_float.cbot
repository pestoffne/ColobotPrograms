public class TestMatrix_float extends EBoost {
	private MatrixElem_float _elem_at(MatrixElem_float p, int x, int y) {
		repeat (x) {
			p = p.right;
		}
		
		repeat (y) {
			p = p.down;
		}

		return p;
	}
	
	private bool _check_structure(Matrix_float m) {
		MatrixElem_float p1, p2, root, last; int width, width_m1, height_m1;
		
		width = m.width();
		width_m1 = width - 1;
		height_m1 = m.height() - 1;
		root = m._root();
		last = _elem_at(root, width_m1, height_m1);
		
		// check last
		if (last.right != null or last.down != null) {
			return false;
		}
		
		// check line 1
		p1 = _elem_at(root, 0, height_m1);
		p2 = root;
		
		repeat (width_m1) {
			if (p1.down != p2.right) {
				return false;
			}
			
			p1 = p1.right;
			p2 = p2.right;
		}
		
		// check lines 2, 3, ...
		p1 = root;
		p2 = _elem_at(root, width_m1, 0);
		
		repeat (width * height_m1) {
			if (p1.down != p2.right) {
				return false;
			}
			
			p1 = p1.right;
			p2 = p2.right;
		}
		
		return true;
	}
	
	void test_matrix_mul_e() {
		Matrix_float m1, m2, m3, e;
		
		// prepare
		m1 = new Matrix_float(3, 3, matrix_values(
			1, 2, 3,
			4, 5, 6,
			7, 8, 9
		));
		
		e = matrix_eye_float(3);
		
		// test
		m2 = m1.mul(e);
		m3 = e.mul(m1);
		
		// assert
		assert(m1.eq(m2), "test_matrix_mul_e: error m1 != m2");
		assert(m1.eq(m3), "test_matrix_mul_e: error m1 != m3");
		assert(_check_structure(m2), "test_matrix_mul_e: error m2 structure");
		assert(_check_structure(m3), "test_matrix_mul_e: error m3 structure");
	}
	
	void test_matrix_mul() {
		Matrix_float m1, m2, m3, m4, m5, m6;
		
		// prepare
		m1 = new Matrix_float(2, 3, matrix_values(
			1, 2,
			3, 4,
			5, 6
		));
		m2 = new Matrix_float(3, 2, matrix_values(
			7, 8, 9,
			10, 11, 12
		));
		m3 = new Matrix_float(3, 3, matrix_values(
			27,  30,  33,
			61,  68,  75,
			95, 106, 117
		));
		m4 = new Matrix_float(2, 2, matrix_values(
			76, 100,
			103, 136
		));
		
		// test
		m5 = m1.mul(m2);
		m6 = m2.mul(m1);
		
		// assert
		assert(m3.eq(m5), "test_matrix_mul: error m3 != m5");
		assert(m4.eq(m6), "test_matrix_mul: error m4 != m6");
		assert(_check_structure(m5), "test_matrix_mul: error m5 structure");
		assert(_check_structure(m6), "test_matrix_mul: error m6 structure");
	}
	
	void test_matrix_mul_sizes() {
		Matrix_float m1, m2, m3, m4, m5;
		
		// prepare
		m1 = matrix_full_float(2, 2, 1.0);
		m2 = matrix_full_float(3, 2, 1.0);
		m3 = matrix_full_float(3, 2, 2.0);
		
		// test
		m4 = m1.mul(m2);
		m5 = m2.mul(m1);
		
		// assert
		assert(m3.eq(m4), "test_matrix_mul_sizes: error m3 != m4");
		assert(m5 == null, "test_matrix_mul_sizes: error m5 != null");
	}
	
	void test_to_str() {
		Matrix_float m; string s1, s2;
		
		// prepare
		m = new Matrix_float(2, 3, matrix_values(
			1, 2,
			3, 4,
			5, 6
		));
		s1 = "[[1,2],[3,4],[5,6]]";
		
		// test
		s2 = m.to_str();
		
		// assert
		assert(s1 == s2, "test_to_str: error s1 != s2");
	}
	
	void test_to_point_2d() {
		Matrix_float m1, m2; point p1, p2, p3; float x, y;
		
		// prepare
		x = 3; y = 5;
		m1 = new Matrix_float(2, 1, matrix_values(x, y));
		m2 = new Matrix_float(1, 2, matrix_values(x, y));
		p3 = new point(x, y);
		
		// test
		p1 = m1.to_point();
		p2 = m2.to_point();
		
		// assert
		assert(p1 == p3, "test_to_point_2d: error p1 != p2");
		assert(p2 == p3, "test_to_point_2d: error p1 != p3");
	}
	
	void test_to_point_3d() {
		Matrix_float m1, m2; point p1, p2, p3; float x, y, z;
		
		// prepare
		x = 4; y = 6; z = 8;
		m1 = new Matrix_float(3, 1, matrix_values(x, y, z));
		m2 = new Matrix_float(1, 3, matrix_values(x, y, z));
		p3 = new point(x, y, z);
		
		// test
		p1 = m1.to_point();
		p2 = m2.to_point();
		
		// assert
		assert(p1 == p3, "test_to_point_3d: error p1 != p3");
		assert(p2 == p3, "test_to_point_3d: error p2 != p3");
	}
	
	void test_matrix_zeros() {
		Matrix_float m1, m2;
		
		// prepare
		m1 = new Matrix_float(3, 2, matrix_values(
			0, 0, 0,
			0, 0, 0
		));
		
		// test
		m2 = matrix_zeros_float(3, 2);
		
		// assert
		assert(m1.eq(m2), "test_matrix_zeros: error m1 != m2");
		assert(_check_structure(m2), "test_matrix_zeros: error m2 structure");
	}
	
	void test_iterator() {
		Matrix_float m; MatrixIterator_float iter;
		
		// prepare
		m = new Matrix_float(2, 3, matrix_values(
			1, 2,
			3, 4,
			5, 6
		));
		
		// test, assert
		iter = m.begin();
		assert(iter.value() == 1, "test_iterator: error 1"); iter.shift();
		assert(iter.value() == 2, "test_iterator: error 2"); iter.shift();
		assert(iter.value() == 3, "test_iterator: error 3"); iter.shift();
		assert(iter.value() == 4, "test_iterator: error 4"); iter.shift();
		assert(iter.value() == 5, "test_iterator: error 5"); iter.shift();
		assert(iter.value() == 6, "test_iterator: error 6"); iter.shift();
		assert(iter.is_null());
	}
	
	void test_iterator_vertical() {
		Matrix_float m; MatrixIteratorVertical_float iter;
		
		// prepare
		m = new Matrix_float(3, 2, matrix_values(
			1, 3, 5,
			2, 4, 6
		));
		
		// test, assert
		iter = m.vbegin();
		assert(iter.value() == 1, "test_iterator_vertical: error 1"); iter.shift();
		assert(iter.value() == 2, "test_iterator_vertical: error 2"); iter.shift();
		assert(iter.value() == 3, "test_iterator_vertical: error 3"); iter.shift();
		assert(iter.value() == 4, "test_iterator_vertical: error 4"); iter.shift();
		assert(iter.value() == 5, "test_iterator_vertical: error 5"); iter.shift();
		assert(iter.value() == 6, "test_iterator_vertical: error 6"); iter.shift();
		assert(iter.is_null());
	}
	
	void test_iterator_vertical_row() {
		Matrix_float m; MatrixIteratorVertical_float iter;
		
		// prepare
		m = new Matrix_float(3, 1, matrix_values(
			1, 2, 3
		));
		
		// test, assert
		iter = m.vbegin();
		
		assert(iter.value() == 1, "test_iterator_vertical_row: error 1"); iter.shift();
		assert(iter.value() == 2, "test_iterator_vertical_row: error 2"); iter.shift();
		assert(iter.value() == 3, "test_iterator_vertical_row: error 3"); iter.shift();
		assert(iter.is_null());
	}
	
	void test_iterator_vertical_column() {
		Matrix_float m; MatrixIteratorVertical_float iter;
		
		// prepare
		m = new Matrix_float(1, 3, matrix_values(
			1,
			2,
			3
		));
		
		// test, assert
		iter = m.vbegin();
		
		assert(iter.value() == 1, "test_iterator_vertical_column: error 1"); iter.shift();
		assert(iter.value() == 2, "test_iterator_vertical_column: error 2"); iter.shift();
		assert(iter.value() == 3, "test_iterator_vertical_column: error 3"); iter.shift();
		assert(iter.is_null());
	}
	
	void test_copy() {
		Matrix_float m1, m2, m3, m4; MatrixElem_float r1;
		
		// prepare
		m1 = new Matrix_float(2, 2, r1 = matrix_values(
			1, 2,
			3, 4
		));
		m2 = new Matrix_float(2, 2, matrix_values(
			1, 2,
			3, 4
		));
		m3 = new Matrix_float(2, 2, matrix_values(
			0, 3,
			2, 4
		));
		
		// test
		m4 = m1.copy();
		m1.transpose_mut();
		r1.value = 0;
		
		// assert
		assert(m2.eq(m4), "test_copy: error incorrect copy");
		assert(m1.eq(m3), "test_copy: error unexpected change");
		assert(_check_structure(m1), "test_copy: error m1 structure");
		assert(_check_structure(m4), "test_copy: error m4 structure");
	}
	
	void test_determenant_3x3_zero() {
		Matrix_float m; float d;
		
		// prepare
		m = new Matrix_float(3, 3, matrix_values(
			1, 2, 3,
			4, 5, 6,
			7, 8, 9
		));
		
		// test
		d = m.determenant();
		
		// assert
		assert(d == 0, "test_determenant_3x3_zero: error");
	}
	
	void test_determenant_3x3() {
		Matrix_float m; float d;
		
		// prepare
		m = new Matrix_float(3, 3, matrix_values(
			2,  3, 4,
			9, 10, 5,
			8,  7, 6
		));
		
		// test
		d = m.determenant();
		
		// assert
		assert(abs(d + 60) < 0.001, "test_determenant_3x3: error");
	}
	
	void test_determenant_3x3_swap_1() {
		Matrix_float m; float d;
		
		// prepare
		m = new Matrix_float(3, 3, matrix_values(
			0, 0, 1,
			1, 0, 0,
			0, 1, 0
		));
		
		// test
		d = m.determenant();
		
		// assert
		assert(abs(d - 1) < 0.001, "test_determenant_3x3_swap_1: error");
	}
	
	void test_determenant_3x3_swap_2() {
		Matrix_float m; float d;
		
		// prepare
		m = new Matrix_float(3, 3, matrix_values(
			0, 0, 1,
			0, 1, 0,
			1, 0, 0
		));
		
		// test
		d = m.determenant();
		
		// assert
		assert(abs(d + 1) < 0.001, "test_determenant_3x3_swap_2: error");
	}
	
	void test_determenant_3x3_swap_3() {
		Matrix_float m; float d;
		
		// prepare
		m = new Matrix_float(3, 3, matrix_values(
			1, 0, 0,
			0, 0, 1,
			0, 1, 0
		));
		
		// test
		d = m.determenant();
		
		// assert
		assert(abs(d + 1) < 0.001, "test_determenant_3x3_swap_3: error");
	}
	
	void test_determenant_4x4() {
		Matrix_float m; float d;
		
		// prepare
		m = new Matrix_float(4, 4, matrix_values(
			10, 11, 12, 13,
			21, 22, 23, 14,
			20, 25, 24, 15,
			19, 18, 17, 16
		));
		
		// test
		d = m.determenant();
		
		assert(abs(d - 1740) < 0.001, "test_determenant_4x4: error");
	}
	
	void test_determenant_4x4_ones() {
		Matrix_float m; float d;
		
		// prepare
		m = new Matrix_float(4, 4, matrix_values(
			0, 0, 0, 1,
			0, 1, 0, 0,
			1, 0, 0, 0,
			0, 0, 1, 0
		));
		
		// test
		d = m.determenant();
		
		assert(abs(d - 1) < 0.001, "test_determenant_4x4_ones: error");
	}
	
	void test_inverse_3x3() {
		Matrix_float m1, m2, m3;
		
		// prepare
		m1 = new Matrix_float(3, 3, matrix_values(
			-0.4, -0.1,  1.6,
			 0.2,  0.3, -0.8,
			 0.6, -0.1, -0.4
		));
		m2 = new Matrix_float(3, 3, matrix_values(
			1,   1,   2,
			2,   4,   0,
			1, 0.5, 0.5
		));
		
		// test
		m3 = m1.inverse();
		
		// assert
		assert(m2.eq(m3), "test_inverse_3x3: error");
		assert(_check_structure(m3), "test_inverse_3x3: error m3 structure");
	}
	
	void test_inverse_4x4_ones() {
		Matrix_float m1, m2, m3;
		
		// prepare
		m1 = new Matrix_float(4, 4, matrix_values(
			0, 0, 0, 1,
			0, 1, 0, 0,
			1, 0, 0, 0,
			0, 0, 1, 0
		));
		m2 = new Matrix_float(4, 4, matrix_values(
			0, 0, 1, 0,
			0, 1, 0, 0,
			0, 0, 0, 1,
			1, 0, 0, 0
		));
		
		// test
		m3 = m1.inverse();
		
		// assert
		assert(m2.eq(m3), "test_inverse_4x4_ones: error");
		assert(_check_structure(m3), "test_inverse_4x4_ones: error m3 structure");
	}
	
	void test_transpose() {
		Matrix_float m1, m2, m3;
		
		// prepare
		m1 = new Matrix_float(3, 2, matrix_values(
			1, 2, 3,
			4, 5, 6
		));
		m2 = new Matrix_float(2, 3, matrix_values(
			1, 4,
			2, 5,
			3, 6
		));
		
		// test
		m3 = m1.transpose();
		
		// assert
		assert(m2.eq(m3), "test_transpose: error");
		assert(_check_structure(m3), "test_transpose: error m3 structure");
	}
	
	void test_transpose_mut() {
		Matrix_float m1, m2;
		
		// prepare
		m1 = new Matrix_float(3, 2, matrix_values(
			1, 2, 3,
			4, 5, 6
		));
		m2 = new Matrix_float(2, 3, matrix_values(
			1, 4,
			2, 5,
			3, 6
		));
		
		// test
		m1.transpose_mut();
		
		// assert
		assert(m1.eq(m2), "test_transpose_mut: error");
		assert(_check_structure(m1), "test_transpose_mut: error m1 structure");
	}
	
	void test_add() {
		Matrix_float m1, m2, m3, m4;
		
		// prepare
		m1 = new Matrix_float(3, 2, matrix_values(
			1, 2, 3,
			4, 5, 6
		));
		m2 = new Matrix_float(3, 2, matrix_values(
			2, 3, 4,
			5, 6, 7
		));
		m3 = new Matrix_float(3, 2, matrix_values(
			3,  5,  7,
			9, 11, 13
		));
		
		// test
		m4 = m1.add(m2);
		
		// assert
		assert(m3.eq(m4), "test_add: error m3 != m4");
		assert(_check_structure(m4), "test_add: error m4 structure");
	}
	
	void test_add_mut() {
		Matrix_float m1, m2, m3;
		
		// prepare
		m1 = new Matrix_float(2, 2, matrix_values(
			1, 2,
			3, 4
		));
		m2 = new Matrix_float(2, 2, matrix_values(
			2, 3,
			4, 5
		));
		m3 = new Matrix_float(2, 2, matrix_values(
			3, 5,
			7, 9
		));
		
		// test
		m1.add_mut(m2);
		
		// assert
		assert(m1.eq(m3), "test_add_mut: error m1 != m3");
		assert(_check_structure(m1), "test_add_mut: error m1 structure");
	}
	
	void test_to_2d_row_matrix() {
		Matrix_float m1, m2; point p; int x, y;
		
		// prepare
		x = 3; y = 5;
		p = new point(x, y);
		m1 = new Matrix_float(2, 1, matrix_values(x, y));
		
		// test
		m2 = to_2d_row_matrix_float(p);
		
		// assert
		assert(m1.eq(m2), "test_to_2d_row_matrix: error m1 != m2");
		assert(_check_structure(m2), "test_to_2d_row_matrix: error m2 structure");
	}
	
	void test_to_3d_row_matrix() {
		Matrix_float m1, m2; point p; int x, y, z;
		
		// prepare
		x = 4; y = 5; z = 6;
		p = new point(x, y, z);
		m1 = new Matrix_float(3, 1, matrix_values(x, y, z));
		
		// test
		m2 = to_3d_row_matrix_float(p);
		
		// assert
		assert(m1.eq(m2), "test_to_3d_row_matrix: error m1 != m2");
		assert(_check_structure(m2), "test_to_3d_row_matrix: error m2 structure");
	}
}

extern void Test_Matrix_float() {
	TestMatrix_float t();
	t.test_matrix_mul_e();
	t.test_matrix_mul();
	t.test_matrix_mul_sizes();
	t.test_to_str();
	t.test_to_point_2d();
	t.test_to_point_3d();
	t.test_matrix_zeros();
	t.test_iterator();
	t.test_iterator_vertical();
	t.test_iterator_vertical_row();
	t.test_iterator_vertical_column();
	t.test_copy();
	t.test_determenant_3x3_zero();
	t.test_determenant_3x3();
	//t.test_determenant_3x3_swap_1(); // Dividing by zero
	//t.test_determenant_3x3_swap_2(); // Dividing by zero
	//t.test_determenant_3x3_swap_3(); // Dividing by zero
	t.test_determenant_4x4();
	//t.test_determenant_4x4_ones(); // Dividing by zero
	t.test_inverse_3x3();
	//t.test_inverse_4x4_ones(); // Dividing by zero
	t.test_transpose();
	t.test_transpose_mut();
	t.test_add();
	t.test_add_mut();
	t.test_to_2d_row_matrix();
	t.test_to_3d_row_matrix();
	message("Tests passed", DisplayInfo);
}
